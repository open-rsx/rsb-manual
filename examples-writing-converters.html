

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Writing Converters &mdash; RSB 1.0-dev documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
        <script type="text/javascript" src="_static/js/multi.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/style.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Tools" href="tools.html" />
    <link rel="prev" title="Writing Plugins" href="examples-plugins.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> RSB
          

          
            
            <img src="_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="news.html">News</a></li>
<li class="toctree-l1"><a class="reference internal" href="concepts.html">Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="install.html">Installing RSB</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="examples.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="examples-basic.html">Basic Communication</a></li>
<li class="toctree-l2"><a class="reference internal" href="examples-chat.html">A Chat System</a></li>
<li class="toctree-l2"><a class="reference internal" href="examples-converters.html">Sending and Receiving Custom Data Types</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="examples-extension-points.html">Extension Points</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="examples-plugins.html">Writing Plugins</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Writing Converters</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#basic-concept">Basic Concept</a></li>
<li class="toctree-l4"><a class="reference internal" href="#using-protocol-buffer-types-in-converters-for-custom-domain-types">Using Protocol Buffer Types in Converters for Custom Domain Types</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="examples-extension-points.html#writing-filters">Writing Filters</a></li>
<li class="toctree-l3"><a class="reference internal" href="examples-extension-points.html#writing-connectors">Writing Connectors</a></li>
<li class="toctree-l3"><a class="reference internal" href="examples-extension-points.html#writing-event-processing-strategies">Writing Event Processing Strategies</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="tools.html">Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="specification.html">Specification</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="support.html">Support</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="literature.html">Literature</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">RSB</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
          <li><a href="examples.html">Examples</a> &raquo;</li>
        
          <li><a href="examples-extension-points.html">Extension Points</a> &raquo;</li>
        
      <li>Writing Converters</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/examples-writing-converters.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            

  
  <div class="section" id="writing-converters">
<span id="tutorial-writing-converters"></span><h1>Writing Converters<a class="headerlink" href="#writing-converters" title="Permalink to this headline">¶</a></h1>
<div class="section" id="basic-concept">
<h2>Basic Concept<a class="headerlink" href="#basic-concept" title="Permalink to this headline">¶</a></h2>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This example has been written with simplicity in mind and should
not be used as a blueprint for production code. In particular:</p>
<ul class="simple">
<li><p>It does not handle machine Endianess properly</p></li>
<li><p>It does not handle machine word sizes properly</p></li>
<li><p>It leaks memory</p></li>
<li><p>It does not validate any data</p></li>
</ul>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In many practical cases, some of these problems (and much of the
manual work) can be avoided by using an IDL-specification in
combination with code generation and generic converters as
described in the <a class="reference external" href="https://developers.google.com/protocol-buffers&lt;F37&gt;">google protocol buffers</a> documentation.</p>
</div>
<p>In RSB, <a class="reference internal" href="glossary.html#term-converter"><span class="xref std std-term">converters</span></a> are used to serialize and
deserialize programming-language objects for transportation (e.g. over
a network connection). RSB comes with <a class="reference internal" href="glossary.html#term-converter"><span class="xref std std-term">converters</span></a> for the fundamental types listed <a class="reference internal" href="concepts.html#types"><span class="std std-ref">here</span></a>. However, in some use-cases it is necessary to use additional
<a class="reference internal" href="glossary.html#term-converter"><span class="xref std std-term">converters</span></a> for domain-specific <a class="reference internal" href="glossary.html#term-data-type"><span class="xref std std-term">data types</span></a> and/or serialization mechanisms.</p>
<p>This example demonstrates how to add such <a class="reference internal" href="glossary.html#term-converter"><span class="xref std std-term">converters</span></a> to RSB using the running example of a
<a class="reference internal" href="glossary.html#term-converter"><span class="xref std std-term">converter</span></a> for a fictional <code class="docutils literal notranslate"><span class="pre">SimpleImage</span></code> <a class="reference internal" href="glossary.html#term-data-type"><span class="xref std std-term">data type</span></a>.</p>
<p>In order to implement a new converter, the following information is
required:</p>
<ul>
<li><p>To/from which <a class="reference internal" href="glossary.html#term-wire-type"><span class="xref std std-term">wire type</span></a> will the <a class="reference internal" href="glossary.html#term-converter"><span class="xref std std-term">converter</span></a>
serialize/deserialize? In our example, the <a class="reference internal" href="glossary.html#term-wire-type"><span class="xref std std-term">wire type</span></a> is an
array of bytes (or more formally an array of octets) which is
represented in C++ using <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">std::string</span></code>.</p></li>
<li><p>Which <a class="reference internal" href="glossary.html#term-data-type"><span class="xref std std-term">data type</span></a> or (<a class="reference internal" href="glossary.html#term-data-type"><span class="xref std std-term">data types</span></a>) will be
handled by the <a class="reference internal" href="glossary.html#term-converter"><span class="xref std std-term">converter</span></a>? The struct &#64;SimpleImage&#64; in our
example (please note that the <a class="reference internal" href="glossary.html#term-data-type"><span class="xref std std-term">data type</span></a> is identified using
a string for comparison, not the class itself).</p></li>
<li><p>What is the <a class="reference internal" href="glossary.html#term-wire-schema"><span class="xref std std-term">wire schema</span></a> of the <a class="reference internal" href="glossary.html#term-converter"><span class="xref std std-term">converter</span></a>? In our
example, we use the following ad-hoc <a class="reference internal" href="glossary.html#term-wire-schema"><span class="xref std std-term">wire schema</span></a>:</p>
<p>Name</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">simple-image</span></code></p>
</div></blockquote>
<p>Binary layout</p>
<blockquote>
<div><p>One integer encoding the image width, one integer encoding the
image height, width x height bytes for the image data.</p>
</div></blockquote>
</li>
</ul>
<div class="lang-multi docutils container">
<div class="lang-python docutils container">
<p>TODO</p>
</div>
<div class="lang-cpp docutils container">
<p><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">converter_tutorial::SimpleImage</span></code> Domain Class</p>
<blockquote>
<div><p>The domain <a class="reference internal" href="glossary.html#term-data-type"><span class="xref std std-term">data type</span></a>:</p>
<div class="highlight-cpp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#pragma once</span>

<span class="k">namespace</span> <span class="n">converter_tutorial</span> <span class="p">{</span>

<span class="k">struct</span> <span class="n">SimpleImage</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">width</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">height</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">data</span><span class="p">;</span>
<span class="p">};</span>

<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div></blockquote>
<p><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">converter_tutorial::SimpleImageConverter</span></code> Class</p>
<blockquote>
<div><p>For the actual <a class="reference internal" href="glossary.html#term-converter"><span class="xref std std-term">converter</span></a> implementation, four things
are needed:</p>
<ol class="arabic simple">
<li><p>The C++ representation of the <a class="reference internal" href="glossary.html#term-wire-type"><span class="xref std std-term">wire type</span></a> has to be
passed to the <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">rsb::converter::Converter</span></code>
interface as a template parameter.</p></li>
<li><p>The <a class="reference internal" href="glossary.html#term-wire-schema"><span class="xref std std-term">wire schema</span></a> and <a class="reference internal" href="glossary.html#term-data-type"><span class="xref std std-term">data type</span></a> name have to
be passed to the <code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">rsb::converter::Converter</span></code>
constructor.</p></li>
<li><p>The <a class="reference internal" href="api-cpp.html#_CPPv4N3rsb9converter9Converter9serializeERK13AnnotatedDataR8WireType" title="rsb::converter::Converter::serialize"><code class="xref cpp cpp-member docutils literal notranslate"><span class="pre">rsb::converter::Converter::serialize</span></code></a>
method has to be implemented.</p></li>
<li><p>The <a class="reference internal" href="api-cpp.html#_CPPv4N3rsb9converter9Converter11deserializeERKNSt6stringERK8WireType" title="rsb::converter::Converter::deserialize"><code class="xref cpp cpp-member docutils literal notranslate"><span class="pre">rsb::converter::Converter::deserialize</span></code></a>
method has to be implemented.</p></li>
</ol>
<p>A naive and incomplete implementation can be found in the
following listings:</p>
<div class="highlight-cpp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#pragma once</span>

<span class="cp">#include</span> <span class="cpf">&lt;rsb/converter/Converter.h&gt;</span><span class="cp"></span>

<span class="k">namespace</span> <span class="n">converter_tutorial</span> <span class="p">{</span>

<span class="cm">/**</span>
<span class="cm"> * A simple converter for the SimpleImage struct. For educational use only.</span>
<span class="cm"> */</span>
<span class="k">class</span> <span class="nc">SimpleImageConverter</span><span class="o">:</span> <span class="k">public</span> <span class="n">rsb</span><span class="o">::</span><span class="n">converter</span><span class="o">::</span><span class="n">Converter</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
    <span class="n">SimpleImageConverter</span><span class="p">();</span>

    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">serialize</span><span class="p">(</span><span class="k">const</span> <span class="n">rsb</span><span class="o">::</span><span class="n">AnnotatedData</span><span class="o">&amp;</span> <span class="n">data</span><span class="p">,</span>
            <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">wire</span><span class="p">);</span>

    <span class="n">rsb</span><span class="o">::</span><span class="n">AnnotatedData</span> <span class="n">deserialize</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">wireSchema</span><span class="p">,</span>
            <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">wire</span><span class="p">);</span>
<span class="p">};</span>

<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<div class="highlight-cpp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;SimpleImageConverter.h&quot;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&quot;SimpleImage.h&quot;</span><span class="cp"></span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">boost</span><span class="p">;</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">rsb</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">rsb</span><span class="o">::</span><span class="n">converter</span><span class="p">;</span>

<span class="k">namespace</span> <span class="n">converter_tutorial</span> <span class="p">{</span>

<span class="c1">// We have to pass two arguments to the base-class constructor:</span>
<span class="c1">// 1. The data-type</span>
<span class="c1">// 2. The wire-schema</span>
<span class="c1">//</span>
<span class="c1">// Note: this could also be written as</span>
<span class="c1">// Converter&lt;string&gt;(&quot;simple-image&quot;, RSB_TYPE_TAG(SimpleImage))</span>
<span class="c1">// to infer the &quot;string&quot; name of the data-type using RTTI.</span>
<span class="n">SimpleImageConverter</span><span class="o">::</span><span class="n">SimpleImageConverter</span><span class="p">()</span> <span class="o">:</span>
    <span class="n">Converter</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="p">(</span><span class="s">&quot;converter_tutorial::SimpleImage&quot;</span><span class="p">,</span> <span class="s">&quot;simple-image&quot;</span><span class="p">,</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>

<span class="n">string</span> <span class="n">SimpleImageConverter</span><span class="o">::</span><span class="n">serialize</span><span class="p">(</span><span class="k">const</span> <span class="n">AnnotatedData</span><span class="o">&amp;</span> <span class="n">data</span><span class="p">,</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">wire</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Ensure that DATA actually holds a datum of the data-type we</span>
    <span class="c1">// expect.</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">first</span> <span class="o">==</span> <span class="n">getDataType</span><span class="p">());</span> <span class="c1">// this-&gt;getDataType() == &quot;converter_tutorial::SimpleImage&quot;</span>

    <span class="c1">// Force conversion to the expected data-type.</span>
    <span class="c1">//</span>
    <span class="c1">// NOTE: a dynamic_pointer_cast cannot be used from void*</span>
    <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">SimpleImage</span><span class="o">&gt;</span> <span class="n">image</span> <span class="o">=</span>
            <span class="n">static_pointer_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">SimpleImage</span><span class="o">&gt;</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">second</span><span class="p">);</span>

    <span class="c1">// Store the content of IMAGE in WIRE according to the selected</span>
    <span class="c1">// binary layout.</span>
    <span class="c1">//</span>
    <span class="c1">// NOTE: do not use this kind of &quot;serialization&quot; for any real code.</span>
    <span class="kt">int</span> <span class="n">numPixels</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
    <span class="n">wire</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">numPixels</span><span class="p">);</span>
    <span class="n">copy</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">wire</span><span class="p">.</span><span class="n">begin</span><span class="p">());</span>
    <span class="n">copy</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">wire</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
    <span class="n">copy</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="n">numPixels</span><span class="p">,</span>
            <span class="n">wire</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>

    <span class="c1">// Return the wire-schema of the serialized representation in</span>
    <span class="c1">// WIRE.</span>
    <span class="k">return</span> <span class="nf">getWireSchema</span><span class="p">();</span> <span class="c1">// this-&gt;getWireSchema() == &quot;simple-image&quot;</span>
<span class="p">}</span>

<span class="n">AnnotatedData</span> <span class="n">SimpleImageConverter</span><span class="o">::</span><span class="n">deserialize</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">wireSchema</span><span class="p">,</span>
        <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">wire</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Ensure that WIRE uses the expected wire-schema.</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">wireSchema</span> <span class="o">==</span> <span class="n">getWireSchema</span><span class="p">());</span> <span class="c1">// this-&gt;getWireSchema() == &quot;simple-image&quot;</span>

    <span class="c1">// Allocate a new SimpleImage object and set its data members from</span>
    <span class="c1">// the content of WIRE.</span>
    <span class="c1">//</span>
    <span class="c1">// NOTE: do not use this kind of &quot;deserialization&quot; for any real</span>
    <span class="c1">// code.</span>
    <span class="n">SimpleImage</span><span class="o">*</span> <span class="n">image</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleImage</span><span class="p">();</span>
    <span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span> <span class="o">&amp;*</span><span class="n">wire</span><span class="p">.</span><span class="n">begin</span><span class="p">());</span>
    <span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span> <span class="o">&amp;*</span><span class="p">(</span><span class="n">wire</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span> <span class="o">+</span> <span class="mi">4</span><span class="p">));</span>
    <span class="n">image</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">unsigned</span> <span class="kt">char</span><span class="p">[</span><span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">];</span>
    <span class="n">copy</span><span class="p">(</span><span class="n">wire</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="n">wire</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span>
            <span class="n">image</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

    <span class="c1">// Return (a shared_ptr to) the constructed object along with its</span>
    <span class="c1">// data-type.</span>
    <span class="k">return</span> <span class="nf">make_pair</span><span class="p">(</span><span class="n">getDataType</span><span class="p">(),</span> <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">SimpleImage</span><span class="o">&gt;</span> <span class="p">(</span><span class="n">image</span><span class="p">));</span>
<span class="p">}</span>

<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div></blockquote>
<p>Using the Converter</p>
<blockquote>
<div><p>A simple program that demonstrates the use of our
<code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">SimpleImageConverter</span></code> can be found in</p>
<div class="highlight-cpp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;boost/shared_ptr.hpp&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;rsb/Factory.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;rsb/converter/Repository.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&quot;SimpleImage.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;SimpleImageConverter.h&quot;</span><span class="cp"></span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">boost</span><span class="p">;</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">rsb</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">rsb</span><span class="o">::</span><span class="n">converter</span><span class="p">;</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">converter_tutorial</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Register our converter within the collection of converters for</span>
    <span class="c1">// the string wire-type (which is used for arrays of octets in</span>
    <span class="c1">// C++).</span>
    <span class="c1">//</span>
    <span class="c1">// Try senderNoConverter.cpp to see what happens, if the converter</span>
    <span class="c1">// is not registered.</span>
    <span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">SimpleImageConverter</span><span class="o">&gt;</span> <span class="n">converter</span><span class="p">(</span><span class="k">new</span> <span class="n">SimpleImageConverter</span><span class="p">());</span>
    <span class="n">converterRepository</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">registerConverter</span><span class="p">(</span><span class="n">converter</span><span class="p">);</span>

    <span class="c1">// Create an Informer object that is parametrized with the</span>
    <span class="c1">// data-type SimpleImage.</span>
    <span class="n">Informer</span><span class="o">&lt;</span><span class="n">SimpleImage</span><span class="o">&gt;::</span><span class="n">Ptr</span> <span class="n">informer</span> <span class="o">=</span>
            <span class="n">getFactory</span><span class="p">().</span><span class="n">createInformer</span><span class="o">&lt;</span><span class="n">SimpleImage</span><span class="o">&gt;</span> <span class="p">(</span>
                    <span class="n">Scope</span><span class="p">(</span><span class="s">&quot;/tutorial/converter&quot;</span><span class="p">));</span>

    <span class="c1">// Construct and send a SimpleImage object.</span>
    <span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">SimpleImage</span><span class="o">&gt;</span> <span class="n">image</span><span class="p">(</span><span class="k">new</span> <span class="n">SimpleImage</span><span class="p">());</span>
    <span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="n">image</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">unsigned</span> <span class="kt">char</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
    <span class="n">informer</span><span class="o">-&gt;</span><span class="n">publish</span><span class="p">(</span><span class="n">image</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>A similar program in which the registration of the
<a class="reference internal" href="glossary.html#term-converter"><span class="xref std std-term">converter</span></a> is missing can be found in</p>
<div class="highlight-cpp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;boost/shared_ptr.hpp&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;rsb/Factory.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&quot;SimpleImage.h&quot;</span><span class="cp"></span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">boost</span><span class="p">;</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">rsb</span><span class="p">;</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">converter_tutorial</span><span class="p">;</span>

<span class="c1">// This program demonstrates the effect of using a data-type for which</span>
<span class="c1">// no converter is available (or at least not registered).</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">Informer</span><span class="o">&lt;</span><span class="n">SimpleImage</span><span class="o">&gt;::</span><span class="n">Ptr</span> <span class="n">informer</span> <span class="o">=</span>
            <span class="n">getFactory</span><span class="p">().</span><span class="n">createInformer</span><span class="o">&lt;</span><span class="n">SimpleImage</span><span class="o">&gt;</span> <span class="p">(</span>
                    <span class="n">Scope</span><span class="p">(</span><span class="s">&quot;/tutorial/converter&quot;</span><span class="p">));</span>

    <span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">SimpleImage</span><span class="o">&gt;</span> <span class="n">image</span><span class="p">(</span><span class="k">new</span> <span class="n">SimpleImage</span><span class="p">());</span>
    <span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="n">image</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">unsigned</span> <span class="kt">char</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
    <span class="n">informer</span><span class="o">-&gt;</span><span class="n">publish</span><span class="p">(</span><span class="n">image</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>This second program serves the purpose of familiarizing you
with the “missing-converter” error message, that you will
encounter sooner or later ;)</p>
</div></blockquote>
</div>
<div class="lang-java docutils container">
<p>TODO</p>
</div>
<div class="lang-cl docutils container">
<p>TODO</p>
</div>
</div>
</div>
<div class="section" id="using-protocol-buffer-types-in-converters-for-custom-domain-types">
<h2>Using Protocol Buffer Types in Converters for Custom Domain Types<a class="headerlink" href="#using-protocol-buffer-types-in-converters-for-custom-domain-types" title="Permalink to this headline">¶</a></h2>
<p>Imagine you have a custom domain type (in this example called <code class="docutils literal notranslate"><span class="pre">FooBar</span></code>) in your software, which you want to use with RSB.
For being able to directly send and receive this type, you need a new <a class="reference internal" href="glossary.html#term-converter"><span class="xref std std-term">converter</span></a>, which handles this type.
Moreover, the generated data to be sent over the wire should be compatible with a data type defined using <a class="reference external" href="https://developers.google.com/protocol-buffers&lt;F37&gt;">google protocol buffers</a> (e.g. from the <a class="reference external" href="http://docs.cor-lab.de/rst-manual/trunk/html/index.html#rst" title="(in RST v0.19)"><span class="xref std std-ref">RST library</span></a>).
For this example, we assume the protocol buffers type is called <code class="docutils literal notranslate"><span class="pre">rst.foo.Bar</span></code>.
To implement a converter matching these assumptions, adapt the following explanations according to your actual data types:</p>
<div class="lang-multi docutils container">
<div class="lang-python docutils container">
<p>TODO</p>
</div>
<div class="lang-cpp docutils container">
<p>Create a header file called <code class="file docutils literal notranslate"><span class="pre">FooBarConverter.h</span></code> and fill it with the following contents:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;rsb/converter/Converter.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;rsb/converter/ProtocolBufferConverter.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;rst/foo/Bar.pb.h&gt;</span><span class="cp"></span>

<span class="k">class</span> <span class="nc">FooBarConverter</span><span class="o">:</span> <span class="k">public</span> <span class="n">rsb</span><span class="o">::</span><span class="n">converter</span><span class="o">::</span><span class="n">Converter</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>

    <span class="n">FooBarConverter</span><span class="p">();</span>
    <span class="k">virtual</span> <span class="o">~</span><span class="n">FooBarConverter</span><span class="p">();</span>

    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">getWireSchema</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>

    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">serialize</span><span class="p">(</span><span class="k">const</span> <span class="n">rsb</span><span class="o">::</span><span class="n">AnnotatedData</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">wire</span><span class="p">);</span>
    <span class="n">rsb</span><span class="o">::</span><span class="n">AnnotatedData</span> <span class="n">deserialize</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">wireType</span><span class="p">,</span>
            <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">wire</span><span class="p">);</span>

<span class="k">private</span><span class="o">:</span>

    <span class="n">rsb</span><span class="o">::</span><span class="n">converter</span><span class="o">::</span><span class="n">ProtocolBufferConverter</span><span class="o">&lt;</span><span class="n">rst</span><span class="o">::</span><span class="n">foo</span><span class="o">::</span><span class="n">Bar</span><span class="o">&gt;</span> <span class="n">converter</span><span class="p">;</span>

<span class="p">};</span>
</pre></div>
</div>
<p>Afterwards, create an implementation file called <code class="file docutils literal notranslate"><span class="pre">FooBarConverter.cpp</span></code> along the following lines:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;FooBarConverter.h&quot;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;rsc/runtime/TypeStringTools.h&gt;</span><span class="cp"></span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="n">FooBarConverter</span><span class="o">::</span><span class="n">FooBarConverter</span><span class="p">()</span> <span class="o">:</span>
        <span class="n">rsb</span><span class="o">::</span><span class="n">converter</span><span class="o">::</span><span class="n">Converter</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;unused&quot;</span><span class="p">,</span> <span class="n">RSB_TYPE_TAG</span><span class="p">(</span><span class="n">FooBar</span><span class="p">))</span> <span class="p">{</span>
<span class="p">}</span>

<span class="n">FooBarConverter</span><span class="o">::~</span><span class="n">FooBarConverter</span><span class="p">()</span> <span class="p">{</span>
<span class="p">}</span>

<span class="n">string</span> <span class="n">FooBarConverter</span><span class="o">::</span><span class="n">getWireSchema</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">converter</span><span class="p">.</span><span class="n">getWireSchema</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">string</span> <span class="n">FooBarConverter</span><span class="o">::</span><span class="n">serialize</span><span class="p">(</span><span class="k">const</span> <span class="n">rsb</span><span class="o">::</span><span class="n">AnnotatedData</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span>
        <span class="n">string</span> <span class="o">&amp;</span><span class="n">wire</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">assert</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">first</span> <span class="o">==</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">getDataType</span><span class="p">());</span>

    <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">FooBar</span><span class="o">&gt;</span> <span class="n">source</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">static_pointer_cast</span><span class="o">&lt;</span><span class="n">FooBar</span><span class="o">&gt;</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">second</span><span class="p">);</span>
    <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">rst</span><span class="o">::</span><span class="n">foo</span><span class="o">::</span><span class="n">Bar</span><span class="o">&gt;</span> <span class="n">dest</span><span class="p">(</span><span class="k">new</span> <span class="n">rst</span><span class="o">::</span><span class="n">foo</span><span class="o">::</span><span class="n">Bar</span><span class="p">());</span>

    <span class="c1">// TODO 1: extract data from domain type and fill it into the protobuf message</span>

    <span class="k">return</span> <span class="n">converter</span><span class="p">.</span><span class="n">serialize</span><span class="p">(</span>
            <span class="n">rsb</span><span class="o">::</span><span class="n">AnnotatedData</span><span class="p">(</span><span class="n">rsc</span><span class="o">::</span><span class="n">runtime</span><span class="o">::</span><span class="n">typeName</span><span class="o">&lt;</span><span class="n">rst</span><span class="o">::</span><span class="n">foo</span><span class="o">::</span><span class="n">Bar</span><span class="o">&gt;</span><span class="p">(),</span> <span class="n">dest</span><span class="p">),</span>
            <span class="n">wire</span><span class="p">);</span>

<span class="p">}</span>

<span class="n">rsb</span><span class="o">::</span><span class="n">AnnotatedData</span> <span class="n">FooBarConverter</span><span class="o">::</span><span class="n">deserialize</span><span class="p">(</span>
        <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">wireType</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">wire</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">rst</span><span class="o">::</span><span class="n">foo</span><span class="o">::</span><span class="n">Bar</span><span class="o">&gt;</span> <span class="n">source</span> <span class="o">=</span>
            <span class="n">boost</span><span class="o">::</span><span class="n">static_pointer_cast</span><span class="o">&lt;</span><span class="n">rst</span><span class="o">::</span><span class="n">foo</span><span class="o">::</span><span class="n">Bar</span><span class="o">&gt;</span><span class="p">(</span>
                    <span class="n">converter</span><span class="p">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">wireType</span><span class="p">,</span> <span class="n">wire</span><span class="p">).</span><span class="n">second</span><span class="p">);</span>

    <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">FooBar</span><span class="o">&gt;</span> <span class="n">dest</span><span class="p">(</span><span class="k">new</span> <span class="n">FooBar</span><span class="p">);</span>

    <span class="c1">// TODO 2: Extract data from the protobuf message and fill it into your domain type</span>

    <span class="k">return</span> <span class="n">rsb</span><span class="o">::</span><span class="n">AnnotatedData</span><span class="p">(</span><span class="n">getDataType</span><span class="p">(),</span> <span class="n">dest</span><span class="p">);</span>

<span class="p">}</span>
</pre></div>
</div>
<p>Your custom conversion logic of how to convert between the Protocol Buffer messages and your custom data types needs to be implemented at the two places indicated with <code class="docutils literal notranslate"><span class="pre">TODO</span></code> comments.
The <a class="reference external" href="https://developers.google.com/protocol-buffers&lt;F37&gt;">google protocol buffers</a> documentation explains how to access the values from in the protocol buffer message.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Please use a reasonable namespace for you actual converter.</p>
</div>
</div>
<div class="lang-java docutils container">
<p>TODO</p>
</div>
<div class="lang-cl docutils container">
<p>TODO</p>
</div>
</div>
</div>
</div>



  


           </div>
           
          </div>
          <footer>
    <div role="contentinfo">
        <span class="creativecommons">
            <a rel="license"
               href="http://creativecommons.org/licenses/by/4.0/">
                <img alt="Creative Commons License"
                     style="border-width:0; width:80px; height:15px; "
                     src="https://i.creativecommons.org/l/by/4.0/80x15.png"/></a>
            <span xmlns:dct="http://purl.org/dc/terms/"
                  href="http://purl.org/dc/dcmitype/Text"
                  property="dct:title"
                  rel="dct:type">
                The RSB documentation
            </span>
            is licensed under a
            <a rel="license"
               href="http://creativecommons.org/licenses/by/4.0/">
                Creative Commons Attribution 4.0 International License
            </a>.
        </span>
        <span class="lastupdated">
            Last updated on Jun 06, 2019.
        </span>
    </div>
</footer>
        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>